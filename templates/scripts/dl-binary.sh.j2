#!/usr/bin/env bash
# vim: ft=bash
set -e

GH_NIMBUS_RELEASE_URL="https://api.github.com/repos/status-im/nimbus-eth2/releases/latest"
GH_NIMBUS_DOWNLOAD_URL="https://github.com/status-im/nimbus-eth2/releases/latest/download/"
ARCH="amd64"
VALIDATOR_CLIENT_SERVICE="{{ validator_client_service_name }}.service"
BUILD_SERVICE="build-{{ validator_client_service_name }}.service"
BINARY_PATH="{{ validator_client_bin_path }}"
#-----------------------------------------------------------------------------------

function getCurrentVersion() {
  result=$(${BINARY_PATH}/nimbus_validator_client --version | grep Nimbus)
  # The version is in format :`Nimbus validator client vx.y.z-abcde-stateofus`
  version=${result/Nimbus validator client v}
  echo "${version/-*-stateofus}"
}

function getLatestBuildName() {
  buildName=$(curl -slf -X GET "${GH_NIMBUS_RELEASE_URL}" | jq -r '.assets[].name' | grep ".*_Linux_${ARCH}_.*.tar.gz")
  echo "${buildName}"
}

function downloadAndInstallBinary() {
  release_name=$1
  version=$(echo $release_name | cut -d_ -f4)
  commit_hash=$(echo $release_name | cut -d_ -f5)
  binary_name="nimbus_validator_client_${version}_${commit_hash}"

  echo "Downloading binary ${release_name}"
  curl -X GET "${GH_NIMBUS_DOWNLOAD_URL}/${release_name}.tar.gz" -L -o "/tmp/${release_name}.tar.gz"
  tar -xvf "/tmp/${release_name}.tar.gz" -C /tmp
  cp "/tmp/${release_name}/build/nimbus_validator_client" "${BINARY_PATH}/${binary_name}"
  ln -sf "${BINARY_PATH}/${binary_name}" "${BINARY_PATH}/nimbus_validator_client"
  rm -r "/tmp/${release_name}"
  rm "/tmp/${release_name}.tar.gz"
}


#-----------------------------------------------------------------------------------

echo " >>> Update Start: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
cd "${SERVICE_PATH}"

if [[ "${USER}" != "{{ validator_client_user }}" ]]; then
    echo "Incorrect user: ${USER}" >&2
    echo "Expected: {{ validator_client_user }}" >&2
    exit 1
fi

if [[ $(systemctl is-active "${BUILD_SERVICE}" || true) == "active" ]]; then
    echo " !!! Build service activate on this host, remove it to launch the update via binary download !"
    exit 1
fi

currentVersion=$(getCurrentVersion)
echo "Validator Client running on version ${currentVersion}"
latestBinaryName=$(getLatestBuildName)
echo "The latest Binary is ${latestBinaryName}"
if [[ "${latestBinaryName}" == "nimbus-eth2_Linux_${ARCH}_${currentVersion}_"* ]]; then
  echo " >>>  BN already running the last version."
  exit 0
else
  echo " >>> Downloading the latest version"
  downloadAndInstallBinary "${latestBinaryName/.tar.gz}"
fi

echo " >>> Restarting service ${VALIDATOR_CLIENT_SERVICE} ..."
sudo systemctl restart "${VALIDATOR_CLIENT_SERVICE}"
